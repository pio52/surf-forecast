<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Surf Forecast</title>

  <!-- Leaflet (sin integrity para evitar bloqueos) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">

  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2e;
      --card2:#0f172a;
      --text:#e8eefc;
      --muted:#a7b3d4;
      --accent:#38bdf8;
      --danger:#ff4d4d;
      --line:rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
    a{color:var(--accent)}
    #app{height:100vh; height:100dvh; width:100vw; position:relative; overflow:hidden;}

    /* Map */
    #map{height:100%; width:100%; background:#0a0f1c;}
    .leaflet-control-attribution{font-size:11px}
    .leaflet-container{background:#0a0f1c;}

    /* Top bar */
    .topbar{
      position:absolute; left:12px; right:12px; top:12px;
      display:flex; gap:10px; align-items:center; z-index:9999;
      pointer-events:none;
    }
    .brand{
      pointer-events:auto;
      display:flex; flex-direction:column;
      background:rgba(16,26,46,.88);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      min-width: 180px;
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.3px}
    .brand p{margin:6px 0 0; font-size:12px; color:var(--muted)}
    .controls{
      margin-left:auto;
      pointer-events:auto;
      display:flex; gap:8px; align-items:center;
      background:rgba(16,26,46,.88);
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(15,23,42,.9);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn.primary{border-color:rgba(56,189,248,.35)}
    .btn.primary:hover{border-color:rgba(56,189,248,.70)}
    .btn.icon{width:36px; display:grid; place-items:center; padding:8px}

    /* Status toast */
    #toast{
      position:absolute; left:12px; right:12px; top:86px;
      z-index:9999;
      background:rgba(255, 240, 210, .95);
      color:#6a3b00;
      border:1px solid rgba(255, 210, 120, .9);
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      display:none;
      white-space:pre-wrap;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }

    /* Bottom sheet panel */
    .sheet{
      position:absolute; left:12px; right:12px; bottom:12px;
      z-index:9999;
      background:rgba(16,26,46,.92);
      border:1px solid var(--line);
      border-radius:18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .sheet.collapsed .sheet-body{display:none;}
    .sheet-header{
      padding:10px 12px;
      display:flex; align-items:center; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .handle{
      width:42px; height:5px; border-radius:999px;
      background:rgba(255,255,255,.25);
      margin: 0 auto;
    }
    .sheet-title{
      display:flex; flex-direction:column; gap:2px;
      width:100%;
    }
    .sheet-title .big{font-size:13px; font-weight:700;}
    .sheet-title .small{font-size:12px; color:var(--muted);}
    .sheet-actions{display:flex; gap:8px; margin-left:auto;}
    .chip{
      border:1px solid var(--line);
      background:rgba(15,23,42,.9);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
    }

    .sheet-body{padding:12px;}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }
    .card{
      background:rgba(15,23,42,.8);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
    }
    .k{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .v{font-size:16px; font-weight:800;}
    .sub{font-size:12px; color:var(--muted); margin-top:4px;}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between;}
    .mono{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1;}

    /* timeline */
    .timeline{
      background:rgba(15,23,42,.8);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      margin-bottom:12px;
    }
    input[type="range"]{width:100%;}
    .timeline-top{display:flex; justify-content:space-between; gap:12px; margin-bottom:6px; align-items:center;}
    .timeline-top .tlabel{font-size:12px; color:var(--muted);}
    .timeline-top .tval{font-size:12px; color:var(--text); font-weight:700;}

    /* mini table */
    .tablewrap{
      background:rgba(15,23,42,.8);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
    }
    table{width:100%; border-collapse:collapse; font-size:12px;}
    th,td{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left;}
    th{color:var(--muted); font-weight:700; background:rgba(255,255,255,.03);}
    tr:last-child td{border-bottom:none;}
    .scroll{max-height: 180px; overflow:auto;}

    /* mobile tweaks */
    @media (max-width: 420px){
      .brand{min-width: 150px}
      .grid{grid-template-columns:1fr}
      .sheet{left:10px; right:10px; bottom:10px;}
    }
  </style>
</head>

<body>
<div id="app">
  <div id="map"></div>

  <div class="topbar">
    <div class="brand">
      <h1 id="uiTitle">Surf Forecast</h1>
      <p id="uiSubtitle">Tap/click the map to pick a spot</p>
    </div>

    <div class="controls">
      <button class="btn" id="btnLang">ES</button>
      <button class="btn" id="btnUnits">m / ft</button>
      <button class="btn icon primary" id="btnSave" title="Guardar favorito">★</button>
    </div>
  </div>

  <div id="toast"></div>

  <div class="sheet collapsed" id="sheet">
    <div class="sheet-header" id="sheetToggle">
      <div style="width:100%;">
        <div class="handle"></div>
        <div class="sheet-title" style="margin-top:8px;">
          <div class="big mono" id="spotLine">—</div>
          <div class="small mono" id="timeLine">—</div>
        </div>
      </div>
      <div class="sheet-actions">
        <span class="chip" id="chipFavs">Favs</span>
        <span class="chip" id="chipClose">Close</span>
      </div>
    </div>

    <div class="sheet-body" id="sheetBody">
      <div class="timeline">
        <div class="timeline-top">
          <div class="tlabel" id="tlLabel">Hora del forecast</div>
          <div class="tval mono" id="tlValue">—</div>
        </div>
        <input type="range" min="0" max="0" value="0" id="rangeTime">
      </div>

      <div class="grid">
        <div class="card">
          <div class="k" id="kWave">Ola total</div>
          <div class="v mono" id="vWave">—</div>
          <div class="sub mono" id="sWave">—</div>
        </div>

        <div class="card">
          <div class="k" id="kWind">Viento</div>
          <div class="v mono" id="vWind">—</div>
          <div class="sub mono" id="sWind">—</div>
        </div>

        <div class="card">
          <div class="k" id="kSwell">Swell</div>
          <div class="v mono" id="vSwell">—</div>
          <div class="sub mono" id="sSwell">—</div>
        </div>

        <div class="card">
          <div class="k" id="kWindWave">Wind-wave</div>
          <div class="v mono" id="vWindWave">—</div>
          <div class="sub mono" id="sWindWave">—</div>
        </div>

        <div class="card">
          <div class="k" id="kWater">Temp mar</div>
          <div class="v mono" id="vWater">—</div>
          <div class="sub mono" id="sWater">—</div>
        </div>

        <div class="card">
          <div class="k" id="kTide">Nivel del mar</div>
          <div class="v mono" id="vTide">—</div>
          <div class="sub mono" id="sTide">—</div>
        </div>
      </div>

      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th id="thTime">Hora</th>
              <th id="thWave">Ola</th>
              <th id="thWind">Viento</th>
              <th id="thPer">Per</th>
              <th id="thDir">Dir</th>
            </tr>
          </thead>
        </table>
        <div class="scroll">
          <table>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:10px; font-size:12px; color:var(--muted)" id="footNote">
        Tip: selecciona un punto en el mar. En tierra el forecast marino puede venir vacío.
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ---------------------------
  // i18n + units
  // ---------------------------
  const i18n = {
    es: {
      title: "Surf Forecast",
      subtitle: "Toca/clic en el mapa para elegir un spot",
      hourLabel: "Hora del forecast",
      close: "Cerrar",
      favs: "Favs",
      wave: "Ola total",
      wind: "Viento",
      swell: "Swell",
      windWave: "Wind-wave",
      water: "Temp mar",
      tide: "Nivel del mar",
      thTime: "Hora", thWave: "Ola", thWind: "Viento", thPer: "Per", thDir: "Dir",
      tip: "Tip: selecciona un punto en el mar. En tierra el forecast marino puede venir vacío.",
      loading: "Cargando datos...",
      noLeaflet: "❌ No cargó Leaflet. Prueba desactivar VPN/adblock o cambiar de red.",
      tileBlocked: "⚠️ El mapa base está bloqueado o sin internet. Prueba otra red/VPN off.",
      noMarine: "No hay datos marinos para este punto. Selecciona un punto más en el mar.",
      saved: "✅ Guardado en favoritos",
      removed: "✅ Eliminado de favoritos",
      pickFav: "Elige un favorito:",
      cancel: "Cancelar",
    },
    en: {
      title: "Surf Forecast",
      subtitle: "Tap/click the map to pick a spot",
      hourLabel: "Forecast time",
      close: "Close",
      favs: "Favs",
      wave: "Total wave",
      wind: "Wind",
      swell: "Swell",
      windWave: "Wind-wave",
      water: "Sea temp",
      tide: "Sea level",
      thTime: "Time", thWave: "Wave", thWind: "Wind", thPer: "Per", thDir: "Dir",
      tip: "Tip: pick a point in the ocean. On land, marine data may be empty.",
      loading: "Loading data...",
      noLeaflet: "❌ Leaflet didn’t load. Try disabling VPN/adblock or switching networks.",
      tileBlocked: "⚠️ Basemap tiles blocked or offline. Try another network / disable VPN.",
      noMarine: "No marine data for this point. Pick a point further offshore.",
      saved: "✅ Saved to favorites",
      removed: "✅ Removed from favorites",
      pickFav: "Pick a favorite:",
      cancel: "Cancel",
    }
  };

  let lang = localStorage.getItem("sf_lang") || "es";
  let units = localStorage.getItem("sf_units") || "metric"; // metric | imperial

  function t(key){ return i18n[lang][key] || key; }

  function setText(){
    document.getElementById("uiTitle").textContent = t("title");
    document.getElementById("uiSubtitle").textContent = t("subtitle");
    document.getElementById("tlLabel").textContent = t("hourLabel");
    document.getElementById("chipClose").textContent = t("close");
    document.getElementById("chipFavs").textContent = t("favs");
    document.getElementById("kWave").textContent = t("wave");
    document.getElementById("kWind").textContent = t("wind");
    document.getElementById("kSwell").textContent = t("swell");
    document.getElementById("kWindWave").textContent = t("windWave");
    document.getElementById("kWater").textContent = t("water");
    document.getElementById("kTide").textContent = t("tide");
    document.getElementById("thTime").textContent = t("thTime");
    document.getElementById("thWave").textContent = t("thWave");
    document.getElementById("thWind").textContent = t("thWind");
    document.getElementById("thPer").textContent = t("thPer");
    document.getElementById("thDir").textContent = t("thDir");
    document.getElementById("footNote").textContent = t("tip");
    document.getElementById("btnLang").textContent = (lang === "es" ? "ES" : "EN");
    document.getElementById("btnUnits").textContent = (units === "metric" ? "m / ft" : "ft / m");
  }

  function metersToFeet(m){ return m * 3.28084; }
  function msToMph(ms){ return ms * 2.23694; }
  function cToF(c){ return (c * 9/5) + 32; }

  function dirText(deg){
    const dirs = ["N","NE","E","SE","S","SW","W","NW"];
    return dirs[Math.round(deg/45) % 8];
  }

  function fmtHeight(m){
    if (m == null || Number.isNaN(m)) return "—";
    if (units === "metric") return `${m.toFixed(2)} m`;
    return `${metersToFeet(m).toFixed(2)} ft`;
  }
  function fmtWind(ms){
    if (ms == null || Number.isNaN(ms)) return "—";
    if (units === "metric") return `${ms.toFixed(1)} m/s`;
    return `${msToMph(ms).toFixed(1)} mph`;
  }
  function fmtTemp(c){
    if (c == null || Number.isNaN(c)) return "—";
    if (units === "metric") return `${c.toFixed(1)} °C`;
    return `${cToF(c).toFixed(1)} °F`;
  }

  // ---------------------------
  // UI elements
  // ---------------------------
  const toast = document.getElementById("toast");
  function showToast(msg){
    toast.style.display = "block";
    toast.textContent = msg;
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display="none", 4000);
  }

  const sheet = document.getElementById("sheet");
  const sheetToggle = document.getElementById("sheetToggle");
  const chipClose = document.getElementById("chipClose");
  const chipFavs = document.getElementById("chipFavs");
  const btnLang = document.getElementById("btnLang");
  const btnUnits = document.getElementById("btnUnits");
  const btnSave = document.getElementById("btnSave");
  const rangeTime = document.getElementById("rangeTime");
  const tlValue = document.getElementById("tlValue");

  chipClose.addEventListener("click", (e)=>{ e.stopPropagation(); sheet.classList.add("collapsed"); });
  sheetToggle.addEventListener("click", ()=> sheet.classList.toggle("collapsed"));
  btnLang.addEventListener("click", ()=>{
    lang = (lang === "es" ? "en" : "es");
    localStorage.setItem("sf_lang", lang);
    setText();
    if (state.data) renderAt(state.index);
  });
  btnUnits.addEventListener("click", ()=>{
    units = (units === "metric" ? "imperial" : "metric");
    localStorage.setItem("sf_units", units);
    setText();
    if (state.data) renderAt(state.index);
  });

  // ---------------------------
  // Favorites
  // ---------------------------
  function loadFavs(){
    try { return JSON.parse(localStorage.getItem("sf_favs") || "[]"); } catch { return []; }
  }
  function saveFavs(favs){
    localStorage.setItem("sf_favs", JSON.stringify(favs));
  }
  function keyFor(lat, lon){ return `${Number(lat).toFixed(4)},${Number(lon).toFixed(4)}`; }

  function toggleFavorite(lat, lon){
    const favs = loadFavs();
    const k = keyFor(lat, lon);
    const ix = favs.findIndex(x => x.k === k);
    if (ix >= 0){
      favs.splice(ix,1);
      saveFavs(favs);
      showToast(t("removed"));
      return false;
    } else {
      favs.push({ k, lat:Number(lat), lon:Number(lon), name: k });
      saveFavs(favs);
      showToast(t("saved"));
      return true;
    }
  }
  function pickFavorite(){
    const favs = loadFavs();
    if (!favs.length){ showToast("No favs yet"); return; }
    // simple prompt
    const list = favs.map((f,i)=> `${i+1}) ${f.name}`).join("\n");
    const ans = prompt(`${t("pickFav")}\n\n${list}\n\n(1-${favs.length})`, "1");
    if (!ans) return;
    const i = Number(ans)-1;
    if (i<0 || i>=favs.length) return;
    const f = favs[i];
    goTo(f.lat, f.lon, true);
  }
  chipFavs.addEventListener("click", (e)=>{ e.stopPropagation(); pickFavorite(); });

  // ---------------------------
  // Map init
  // ---------------------------
  setText();

  if (!window.L){
    showToast(t("noLeaflet"));
    throw new Error("Leaflet not loaded");
  }

  const map = L.map("map").setView([15.86, -97.07], 7);

  const tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  tiles.on("tileerror", ()=> showToast(t("tileBlocked")));

  let marker = null;

  // ---------------------------
  // Data fetch (Open-Meteo)
  //  - Marine: waves + swell + wind-wave + SST + sea level
  //  - Weather: wind speed/dir + gusts
  // ---------------------------
  async function fetchJson(url){
    const resp = await fetch(url, { cache: "no-store" });
    if (!resp.ok){
      const txt = await resp.text().catch(()=> "");
      throw new Error(`HTTP ${resp.status}: ${txt.slice(0,300)}`);
    }
    return resp.json();
  }

  async function getMarine(lat, lon){
    const url =
      `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}` +
      `&hourly=` +
      [
        "wave_height","wave_direction","wave_period",
        "swell_wave_height","swell_wave_direction","swell_wave_period",
        "wind_wave_height","wind_wave_direction","wind_wave_period",
        "sea_surface_temperature",
        "sea_level_height_msl"
      ].join(",") +
      `&timezone=auto&forecast_days=3`;
    return fetchJson(url);
  }

  async function getWeather(lat, lon){
    const url =
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&hourly=wind_speed_10m,wind_direction_10m,wind_gusts_10m` +
      `&timezone=auto&forecast_days=3`;
    return fetchJson(url);
  }

  function nearestIndex(times){
    const now = new Date();
    let best = 0, bestDiff = Infinity;
    for (let i=0;i<times.length;i++){
      const d = new Date(times[i]);
      const diff = Math.abs(d - now);
      if (diff < bestDiff){ bestDiff = diff; best = i; }
    }
    return best;
  }

  const state = {
    lat:null, lon:null,
    data:null, // combined
    index:0
  };

  async function goTo(lat, lon, fromFav=false){
    state.lat = Number(lat);
    state.lon = Number(lon);

    if (marker) marker.remove();
    marker = L.marker([state.lat, state.lon]).addTo(map);

    map.panTo([state.lat, state.lon]);

    showToast(t("loading"));

    const [marine, weather] = await Promise.all([ getMarine(lat, lon), getWeather(lat, lon) ]);

    if (!marine.hourly || !marine.hourly.time || !marine.hourly.time.length){
      showToast(t("noMarine"));
      throw new Error("No marine data");
    }

    const idx = nearestIndex(marine.hourly.time);
    const idxW = nearestIndex(weather.hourly.time);

    state.data = { marine, weather, idxWBase: idxW };
    state.index = idx;

    // setup slider
    rangeTime.min = 0;
    rangeTime.max = marine.hourly.time.length - 1;
    rangeTime.value = idx;

    sheet.classList.remove("collapsed");

    renderAt(idx);
  }

  function renderAt(i){
    state.index = i;

    const marine = state.data.marine;
    const weather = state.data.weather;

    const tISO = marine.hourly.time[i];
    const tPretty = tISO.replace("T"," ");

    // For weather index: assume same cadence/timezone; pick nearest by same i if exists
    let wi = i;
    if (!weather.hourly.time || wi >= weather.hourly.time.length){
      wi = Math.min(state.data.idxWBase, weather.hourly.wind_speed_10m.length-1);
    }

    const waveH = marine.hourly.wave_height[i];
    const wavePer = marine.hourly.wave_period[i];
    const waveDir = marine.hourly.wave_direction[i];

    const swellH = marine.hourly.swell_wave_height?.[i];
    const swellPer = marine.hourly.swell_wave_period?.[i];
    const swellDir = marine.hourly.swell_wave_direction?.[i];

    const wwH = marine.hourly.wind_wave_height?.[i];
    const wwPer = marine.hourly.wind_wave_period?.[i];
    const wwDir = marine.hourly.wind_wave_direction?.[i];

    const wSp = weather.hourly.wind_speed_10m?.[wi];
    const wDir = weather.hourly.wind_direction_10m?.[wi];
    const gust = weather.hourly.wind_gusts_10m?.[wi];

    const sst = marine.hourly.sea_surface_temperature?.[i];
    const sea = marine.hourly.sea_level_height_msl?.[i];

    // header lines
    document.getElementById("spotLine").textContent =
      `Lat ${state.lat.toFixed(4)}  Lon ${state.lon.toFixed(4)}`;
    document.getElementById("timeLine").textContent = tPretty;
    tlValue.textContent = tPretty;

    // cards
    document.getElementById("vWave").textContent = fmtHeight(waveH);
    document.getElementById("sWave").textContent =
      `${wavePer?.toFixed?.(1) ?? "—"} s • ${dirText(waveDir)} (${(waveDir ?? 0).toFixed(0)}°)`;

    document.getElementById("vWind").textContent = fmtWind(wSp);
    document.getElementById("sWind").textContent =
      `${dirText(wDir)} (${(wDir ?? 0).toFixed(0)}°) • gust ${fmtWind(gust)}`;

    document.getElementById("vSwell").textContent = fmtHeight(swellH);
    document.getElementById("sSwell").textContent =
      `${swellPer?.toFixed?.(1) ?? "—"} s • ${dirText(swellDir)} (${(swellDir ?? 0).toFixed(0)}°)`;

    document.getElementById("vWindWave").textContent = fmtHeight(wwH);
    document.getElementById("sWindWave").textContent =
      `${wwPer?.toFixed?.(1) ?? "—"} s • ${dirText(wwDir)} (${(wwDir ?? 0).toFixed(0)}°)`;

    document.getElementById("vWater").textContent = fmtTemp(sst);
    document.getElementById("sWater").textContent = (units === "metric" ? "SST" : "SST");

    document.getElementById("vTide").textContent = (sea==null ? "—" : `${sea.toFixed(2)} m`);
    document.getElementById("sTide").textContent = "MSL (aprox)";

    // table (next 24 hours)
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    const start = i;
    const end = Math.min(i+24, marine.hourly.time.length);

    for (let k=start; k<end; k++){
      const time = marine.hourly.time[k].slice(11,16);
      const wh = marine.hourly.wave_height[k];
      const ws = weather.hourly.wind_speed_10m?.[Math.min(k, weather.hourly.wind_speed_10m.length-1)];
      const per = marine.hourly.wave_period[k];
      const dir = marine.hourly.wave_direction[k];

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${time}</td>
        <td class="mono">${fmtHeight(wh)}</td>
        <td class="mono">${fmtWind(ws)}</td>
        <td class="mono">${per?.toFixed?.(1) ?? "—"}s</td>
        <td class="mono">${dirText(dir)} ${(dir ?? 0).toFixed(0)}°</td>
      `;
      tbody.appendChild(tr);
    }
  }

  rangeTime.addEventListener("input", ()=> {
    if (!state.data) return;
    renderAt(Number(rangeTime.value));
  });

  // Save favorite
  btnSave.addEventListener("click", ()=>{
    if (state.lat == null || state.lon == null){
      showToast("Pick a spot first");
      return;
    }
    toggleFavorite(state.lat, state.lon);
  });

  // Map click
  map.on("click", async (e)=>{
    const lat = e.latlng.lat.toFixed(4);
    const lon = e.latlng.lng.toFixed(4);
    try{
      await goTo(lat, lon);
    }catch(err){
      showToast((err && err.message) ? err.message : String(err));
    }
  });

</script>
</body>
</html>
