<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Surf Forecast Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS (SIN integrity) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">

  <style>
    body { margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding: 14px 14px 8px; }
    #status { padding: 0 14px 10px; color: #b00020; font-size: 14px; }
    #map { height: calc(100vh - 120px); min-height: 420px; }
  </style>
</head>

<body>
  <header>
    <h2 style="margin:0;">Surf Forecast Demo</h2>
    <p style="margin:8px 0 0;">Haz clic/toca cualquier punto del mapa para ver el pronóstico (Open-Meteo).</p>
  </header>

  <div id="status"></div>
  <div id="map"></div>

  <!-- Leaflet JS (SIN integrity) -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    (function () {
      const status = document.getElementById("status");

      // Si Leaflet no cargó, lo avisamos
      if (!window.L) {
        status.textContent =
          "❌ No se cargó el mapa (Leaflet). Revisa tu internet o si tu red está bloqueando el CDN. " +
          "Intenta abrir en modo incógnito o desactiva bloqueadores.";
        return;
      }

      try {
        const map = L.map('map').setView([20, -100], 3);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          maxZoom: 18
        }).addTo(map);

        function metersToFeet(m) { return m * 3.28084; }
        function msToMph(ms) { return ms * 2.23694; }

        async function fetchForecast(lat, lon) {
          const url =
            `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}` +
            `&hourly=wave_height,wave_direction,wave_period,wind_speed,wind_direction` +
            `&timezone=auto&forecast_days=3`;

          const resp = await fetch(url);
          if (!resp.ok) throw new Error('Error al obtener datos');
          return resp.json();
        }

        function formatDirection(deg) {
          const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
          const ix = Math.round(deg / 45) % 8;
          return dirs[ix];
        }

        map.on('click', async (e) => {
          const { lat, lng } = e.latlng;
          try {
            const data = await fetchForecast(lat.toFixed(4), lng.toFixed(4));
            const idx = 0;

            const waveHeight = data.hourly.wave_height[idx];
            const waveDirection = data.hourly.wave_direction[idx];
            const wavePeriod = data.hourly.wave_period[idx];
            const windSpeed = data.hourly.wind_speed[idx];
            const windDir = data.hourly.wind_direction[idx];

            const content = `
              <div style="font-size:14px;">
                <strong>${data.hourly.time[idx].replace('T',' ')}</strong><br><br>
                <table style="border-collapse:collapse; width:100%;">
                  <tr><th style="border:1px solid #ccc; padding:4px;">Métrica</th><th style="border:1px solid #ccc; padding:4px;">SI</th><th style="border:1px solid #ccc; padding:4px;">Imperial</th></tr>
                  <tr><td style="border:1px solid #ccc; padding:4px;">Altura ola</td><td style="border:1px solid #ccc; padding:4px;">${waveHeight.toFixed(2)} m</td><td style="border:1px solid #ccc; padding:4px;">${metersToFeet(waveHeight).toFixed(2)} ft</td></tr>
                  <tr><td style="border:1px solid #ccc; padding:4px;">Período</td><td style="border:1px solid #ccc; padding:4px;" colspan="2">${wavePeriod.toFixed(1)} s</td></tr>
                  <tr><td style="border:1px solid #ccc; padding:4px;">Dir. ola</td><td style="border:1px solid #ccc; padding:4px;" colspan="2">${formatDirection(waveDirection)} (${waveDirection.toFixed(0)}°)</td></tr>
                  <tr><td style="border:1px solid #ccc; padding:4px;">Viento</td><td style="border:1px solid #ccc; padding:4px;">${windSpeed.toFixed(1)} m/s</td><td style="border:1px solid #ccc; padding:4px;">${msToMph(windSpeed).toFixed(1)} mph</td></tr>
                  <tr><td style="border:1px solid #ccc; padding:4px;">Dir. viento</td><td style="border:1px solid #ccc; padding:4px;" colspan="2">${formatDirection(windDir)} (${windDir.toFixed(0)}°)</td></tr>
                </table>
              </div>
            `;

            L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
            status.textContent = ""; // limpia errores
          } catch (err) {
            status.textContent = "❌ " + err.message;
          }
        });

      } catch (err) {
        status.textContent = "❌ Error inicializando mapa: " + err.message;
      }
    })();
  </script>
</body>
</html>
